<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ static_version }}">
</head>
<body onload="save()">
<div class="app-shell">
    <div class="header"><a href="/" class="back-arrow">‚Üê</a><h1>Results</h1></div>
    <div class="card" style="text-align:center;">
        <h1 id="potholeCount" style="color:var(--blue); font-size:45px; margin:0;">{{ potholes }}</h1>
        <p>Potholes Found</p>
        <p style="font-size:11px; margin-bottom:10px;">üìç {{ address }}</p>
        {% if has_location %}
        <iframe width="100%" height="180" style="border-radius:15px; border:none;" 
            src="https://maps.google.com/maps?q={{ lat }},{{ lon }}&z=15&output=embed">
        </iframe>
        {% else %}
        <p style="font-size:12px; color:#64748b; margin:10px 0;">üìç Enable location when detecting to see map.</p>
        {% endif %}
    </div>
    <div class="card">
        <div class="image-grid">
            {% for img in images %} <img src="/static/results/{{img}}"> {% endfor %}
        </div>
        <button class="btn btn-blue" onclick="go()">üì¢ Generate Report</button>
        <button class="btn btn-outline" onclick="window.location.href='/'">üè† Go Home</button>
    </div>
</div>
<script>
const reportDate = new Date().toLocaleString();
const images = {{ images|tojson }};
const potholesCount = {{ potholes }};
const address = {{ address|tojson }};
const lat = {{ lat|tojson }};
const lon = {{ lon|tojson }};

function save() {
    var h = JSON.parse(localStorage.getItem('pothole_history') || '[]');
    var fullImgs = images.map(function(img) { return window.location.origin + '/static/results/' + img; });
    var item = { potholes: potholesCount, address: address, lat: lat, lon: lon, images: fullImgs, date: reportDate };
    h.unshift(item);
    localStorage.setItem('pothole_history', JSON.stringify(h));
    sessionStorage.setItem('last_result_item', JSON.stringify(item));
}

function go() {
    sessionStorage.setItem('current_complaint', JSON.stringify({
        potholes: potholesCount,
        address: address,
        lat: lat,
        lon: lon,
        all_images: images,
        date: reportDate
    }));
    window.location.href = '/complaint';
}
</script>
</body>
</html>
